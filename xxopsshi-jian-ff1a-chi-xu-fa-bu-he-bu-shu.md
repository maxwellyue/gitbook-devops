CMDB、应用配置管理等属于基础层面的东西，如果用不起来，就没有价值，那我们今天就来看看在此基础之上的一些实践。

## 为什么要做持续发布和部署
---
首先，根本原因还是为了提升代码的交付效率（好像是句正确的废话），从技术上，主要原因还是因为从单体工程拆分成了服务化的应用。

单体工程的历史原因也很好理解，在创业初期，技术人员有限的情况下，为了快速找到正确的业务发展方向，技术人员必定会把全部的精力放到业务需求的实现上，这时技术或架构层面的事情是次要的，且在创业早期，用户量和业务模型也没有这么复杂，也没有必要搞复杂的架构出来，LNMP足矣，从我们的实践来看这样的技术选择是无比正确的。

但是，随着业务量和业务复杂度的增加（如电商的用户、商家、店铺、商品、交易和支付体系），业务服务质量要求变得越来越苛刻（低时延、高可用），需求的交付周期却要求越来越短（脑补下产品经理站在程序员身后的场景），同时工程师数量也已经到了几百人规模，这时单体工程就暴露出很多问题，比如代码逻辑耦合严重、底层公共方法不敢动，代码量巨大已经没有任何一个人能对整个工程代码熟悉，上百个工程师同时向同一个工程提交代码，代码维护耗费的精力非常大。

发布做的事情就是，将提交后的应用代码，进行编译打包，然后发布到应用对应IP主机的指定目录下，并且做到应用服务的优雅上下线（或者叫做优雅启停）。

## 怎么做持续发布和部署
---
其实我们可以抽象出发布的最重要的三步，我们也是始终围绕着这三步在不断的完善，如下：代码提交>编译构建>部署。

##### 代码提交环节
描述如下：

1、master分支，跟线上应用代码保持同步，也就是说随时可以发布到线上进行部署运行。

2、开发分支，通常以feature/defect来表示，比如开发一个新的需求，就会以当前master为基线，拉一个feature分支出来进行开发，同一个应用可以同时存在多个feature分支并行开发。

3、发布分支，以release表示，在发布时会将所有提交集成的代码commit合并，形成release_环境_时间戳为分支名称，比如release_dev_01_29_20_52_10 就代表该分支是在1月29号20:52:10在dev环境发布时创建的临时发布分支。

4、从预发进入线上时，会以当前预发环境的发布分支release_pre_xxxx为基线创建一个release_online分支，作为线上的发布分支，线上发布结束后会把release_online分支合并到master中，这也就保证了发布到线上的代码最终一定会跟master的代码保持一致。

##### 编译构建环节
以Java为例，构建我们用到了两个工具，Docker和Maven。Docker主要用来提供一个干净独立的编译环境，Maven作为我们的依赖管理和打包工具。整个构建过程如下：

1、首先准备好JDK的编译镜像，这个镜像环境与线上环境保持一致，当有新的构建任务进来时，就创建一个对应的Docker实例进行代码编译；

2、构建任务会根据应用配置管理中的Git地址，将代码clone下来放到指定的编译目录，Docker实例启动后，将编译目录挂在到Docker实例中；

3、对于Java应用，在这个Docker实例环境中，就可以执行mvn package命令打包了，最终会生成一个可发布xxx.war的软件包；

4、同样的，对于C++，Go、NodeJs，也会准备好类似的编译镜像，不同的是打包时，对于C++是cmake&make，Go就是go install等等，最终也会生成一个可发布的软件包；

5、构建完成后，Docker实例销毁；

>这里面Docker发挥了一个很大的作用，就是提供了干净的，互不干扰的编译环境，且对于并发打包的情况，Docker快速创建多个并行的实例出来提供编译环境，使用完销毁，这个效率上的优势也是非常大的。

6、关于配置管理，当时设计时考虑比较简单，我们的做法是同时做三个配置文件出来，dev_pom.xml，pre_pom.xml，online_pom.xml，分别对应开发、预发和线上三个不同的环境，根据发布的环境不同，将不同的配置文件替换上去。这样做其实可扩展性不够，对于多机房、多分组的情况会有更多的配置文件创建出来，且对于有敏感信息的配置项保密也不够（不过这些配置都已经加密挪到中间件的配置中心了），更好的办法可以考虑采用阿里早已开源的auto-config方案，这里就不细讲了。


###### 部署环节
将代码发布到应用对应IP主机的指定目录下，并且能够优雅的上下线应用服务。

原文作者没有描述完善的多部署方案。

---

内容来源：
[XXOps实践：持续发布和部署](https://mp.weixin.qq.com/s?__biz=MzI1MTMwMTQ1MA==&mid=2247483809&idx=1&sn=42ab37c8c493114814387ef77c6bb4d7&chksm=e9f45a84de83d3923d2bfcb45726effc979a6a01af15e5e85ad57ad383c4933c6dc18a11cf8d&scene=21#wechat_redirect)
